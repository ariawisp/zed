#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"

ZED_WIT="$(cd "$ROOT_DIR/.." && pwd)/zed-extension-wit/wit/redwood/protocol/protocol.wit"
REDWOOD_WIT="$(cd "$ROOT_DIR/.." && pwd)/redwood/wit/protocol/protocol.wit"

if [[ ! -f "$ZED_WIT" ]]; then
  echo "Zed protocol WIT not found: $ZED_WIT" >&2
  exit 1
fi

if [[ ! -f "$REDWOOD_WIT" ]]; then
  echo "Redwood protocol WIT not found: $REDWOOD_WIT" >&2
  exit 1
fi

ZED_SHA=$(shasum -a 256 "$ZED_WIT" | awk '{print $1}')
REDWOOD_SHA=$(shasum -a 256 "$REDWOOD_WIT" | awk '{print $1}')

if [[ "$ZED_SHA" != "$REDWOOD_SHA" ]]; then
  echo "Protocol WIT mismatch:" >&2
  echo "  Zed:     $ZED_WIT ($ZED_SHA)" >&2
  echo "  Redwood: $REDWOOD_WIT ($REDWOOD_SHA)" >&2
  echo "Please sync the files before committing/publishing." >&2
  exit 2
fi

echo "Protocol WIT OK ($ZED_SHA)"
exit 0
